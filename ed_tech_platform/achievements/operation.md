# サービス運用

## 監視設計
### 課題
一定の時期に利用がスパイクする機能で、毎回その時の対応で済ませていて、対策ができていない状況でした。

### 対応
実装を対応して下さったエンジニアと協力してアーキテクチャを一緒に考えました。
監視するメトリクスの選定、閾値設定、運用を行いました。

### 成果
このメトリクスから事前にサーバ増強をSREに依頼する事で対策可能になりました。
監視追加後は、毎回起きていた障害は発生せずに運用できるようになりました。

## ログ収集基盤

### 目的
元々のアプリケーションログを収集していただけので有効に活用できていなかった状態を、SREと共に調査、分析に有効に利用できる様に改善

### 課題
* アプリケーションログに必要な情報が整理されていない。情報が足りない。
* Rails標準のログが解析し難い。
* Railsのログ出力処理の知見を持っているメンバーがいなかった。
* データ活用するメンバーが主に企画部署だったため、エンジニアが使うケースが無かった為対応したいエンジニアが出てこなかった。

### やったこと
Rails/SidekiqのログをカスタマイズしRailsログのJson化及びログ出力内容のカスタマイズを実施し知見共有を行いました。
それにより、AWS Glueでのパース処理が不要かつ、出力要素がいくら増えても自動でAthena用テーブルへのマッピングが可能になりました。
また、社内でカスタムログを出力する時の必須項目、項目名の統一などガイドラインの作成と普及を行いました。

### 構成
* fruentd
* AWS kinesis
* AWS kinesis Stream
* AWS Glue
* AWS Athenaで分析

### その後
分析用のログ出力が簡単に出せるかつ、ガイドラインが整備された事で様々なプロダクトで活用され、データ活用が促進されました。

## Ruby/Railsバージョンアップ

詳細は[こちらのスライド](https://speakerdeck.com/soarteclab/railsbaziyonatupushi-dong-wu-yu)に残しています。

### 課題
以下の状態でどう進めて良いか分からない状況でした。

* バージョンアップの知見が少ない
* バージョンアップの体制ができていない
* 技術顧問の見積での必要工数13人年

### やった事
#### 1つのサービスを1ヶ月でruby/railsを最新バージョンにバージョンアップ
1つの機能を1ヶ月で、バグ発生0件で、以下のバージョンアップを行いました。
* rails4.1 -> 5.2
* ruby2.3 -> 2.6

実際に必要な期間と安全にできるファクトを用意する事で組織に安心と自身をつけました。

#### 知見の共有
その後エンジニアが増え、私はバージョンアップ作業から外れたので以下の知見をドキュメントに残した上で、
slackでの相談対応や、詰まった時のペアプロを行いました。

* 気を付ける変更点
* warnnigの消し方
* 対応した履歴

またArelの変更など情報、知見の少ない部分についても確認方法を共有し安全なバージョンアップに貢献しました。

## Railsセキュリティバグトリアージ対応

### 課題
* セキュリティバグに対する体制がない(だれが、どうやってのフローが決まっていない)

### やった事

サービスに影響のあるセキュリティバグの情報公開がされた時に、トリアージ及び対策を行いました。
また各プロセスの時間計測、課題を挙げる事で組織体制の強化に貢献しました。

#### 実際のトリアージ内容
1. 発生したインシデントの情報を収集し、自社で対応すべきものかどうかを判断する
2. 対応方法の整理
* バージョンアップする or パッチをあてる
* デグレートする箇所がないか
* リリースの方法(一部のサービスで適応するなど)
3. 関係者へ周知

#### 実際トリアージにかかった時間
発生したインシデントの情報を収集し、自社で対応すべきものかどうかを判断する
-> 30分

対応方法の整理
-> 2時間

合計 2時間30分

関係者の周知までにかかった時間
-> 12日

GMOべパぼのセキュリティ対策室と同等のスピード
https://tech.pepabo.com/2019/03/18/analysis-rails-vulnerabilities/

### その後

セキュリティバグに対する体制ができました。